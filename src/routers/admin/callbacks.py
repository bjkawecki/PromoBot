from aiogram import F, Router
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup

from config import ADMIN_USER_NAME
from database.dynamodb import dynamodb
from database.seller_repository import get_seller_by_id, save_seller
from keyboards.common import get_back_to_start_keyboard
from misc import format_datetime
from routers.admin.states import AddSeller

router = Router()


@router.callback_query(F.data == "add_seller")
async def add_seller_callback(callback: CallbackQuery, state: FSMContext):
    if callback.from_user.username != ADMIN_USER_NAME:
        await callback.answer("Keine Berechtigung.", show_alert=True)
        return

    await callback.message.answer(
        "*Neuer Verk√§ufer hinzuf√ºgen*\n\n"
        "Bitte sende die Telegram\\-Nutzer\\-ID des neuen Verk√§ufers:",
        parse_mode="MarkdownV2",
        reply_markup=get_back_to_start_keyboard(),
    )
    await callback.answer()
    await state.set_state(AddSeller.waiting_for_username)


@router.callback_query(F.data == "display_sellers")
async def display_sellers_callback(callback: CallbackQuery):
    table = dynamodb.Table("seller")
    try:
        response = table.scan()
        seller_list = response.get("Items", [])
        if not seller_list:
            await callback.message.answer(
                "‚ùå Es sind noch keine Verk√§ufer registriert."
            )
            return

        # Liste formatieren
        buttons = []
        for seller in seller_list:
            display_name = seller.get("display_name", None)
            telegram_id = seller["telegram_user_id"]
            button_text = display_name if display_name else str(telegram_id)
            buttons.append(
                [
                    InlineKeyboardButton(
                        text=button_text, callback_data=f"seller_detail:{telegram_id}"
                    )
                ]
            )
        buttons.append(
            [
                InlineKeyboardButton(text="Abbrechen", callback_data="back_to_start"),
            ],
        )
        markup = InlineKeyboardMarkup(inline_keyboard=buttons)

        await callback.message.answer("W√§hle einen Verk√§ufer aus:", reply_markup=markup)
        await callback.answer()

    except Exception as e:
        await callback.message.answer("‚ö†Ô∏è Fehler beim Abrufen der Verk√§ufer.")
        print(f"[ERROR] {e}")


@router.callback_query(F.data.startswith("seller_detail:"))
async def seller_detail_callback(callback: CallbackQuery):
    telegram_id = callback.data.split(":")[1]

    seller = get_seller_by_id(int(telegram_id))
    if not seller:
        await callback.message.answer("Verk√§ufer nicht gefunden.")
        return

    msg = (
        f"<b>Verk√§ufer: {seller.get('display_name', '-')}</b>\n"
        f"Nutzername: {seller.get('Nutzername')}\n"
        f"Nutzer-ID: {seller.get('telegram_user_id', '-')}\n"
        f"Firma: {seller.get('business_name', '-')}\n"
        f"E-Mail: {seller.get('contact_email', '-')}\n"
        f"Telefon: {seller.get('contact_phone', '-')}\n"
        f"Homepage: {seller.get('homepage', '-')}\n"
        f"Aktiv: {'Ja' if seller.get('active') else 'Nein'}\n"
        f"Registriert: {'Ja' if seller.get('registered') else 'Nein'}\n"
        f"Hinzugef√ºgt: {format_datetime(seller.get('created_at'))}"
    )

    inline_keyboard = []
    if seller.get("active", False):
        inline_keyboard.append(
            [
                InlineKeyboardButton(
                    text="üö´ Deaktivieren",
                    callback_data=f"seller_toggle:{telegram_id}:deactivate",
                )
            ],
        )
    else:
        inline_keyboard.append(
            [
                InlineKeyboardButton(
                    text="‚úÖ Aktivieren",
                    callback_data=f"seller_toggle:{telegram_id}:activate",
                )
            ]
        )
    inline_keyboard.append(
        [
            InlineKeyboardButton(
                text="üîô Zur√ºck zur √úbersicht", callback_data="display_sellers"
            )
        ]
    )
    keyboard = InlineKeyboardMarkup(inline_keyboard=inline_keyboard)

    await callback.message.edit_text(msg, reply_markup=keyboard, parse_mode="HTML")


@router.callback_query(F.data.startswith("seller_toggle:"))
async def seller_toggle_callback(callback: CallbackQuery):
    _, telegram_id, action = callback.data.split(":")

    confirm_text = (
        "‚ùóÔ∏èBist du sicher, dass du diesen Verk√§ufer "
        f"{'aktivieren' if action == 'activate' else 'deaktivieren'} m√∂chtest?"
    )

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚úÖ Ja", callback_data=f"confirm_toggle:{telegram_id}:{action}"
                ),
                InlineKeyboardButton(
                    text="‚ùå Abbrechen", callback_data=f"cancel_toggle:{telegram_id}"
                ),
            ]
        ]
    )

    await callback.message.answer(confirm_text, reply_markup=keyboard)
    await callback.answer()


@router.callback_query(F.data.startswith("cancel_toggle"))
async def cancel_toggle_callback(callback: CallbackQuery):
    await callback.answer("‚ùé Vorgang abgebrochen.")
    await seller_detail_callback(callback)
    await callback.answer()


@router.callback_query(F.data.startswith("confirm_toggle:"))
async def confirm_toggle_callback(callback: CallbackQuery):
    _, telegram_id, action = callback.data.split(":")

    seller = get_seller_by_id(int(telegram_id))
    if not seller:
        await callback.message.answer("‚ùå Verk√§ufer nicht gefunden.")
        return

    seller["active"] = True if action == "activate" else False
    save_seller(seller)

    status_text = (
        "‚úÖ Verk√§ufer wurde aktiviert."
        if seller["active"]
        else "üö´ Verk√§ufer wurde deaktiviert."
    )
    await callback.answer(status_text)

    await seller_detail_callback(callback)
    await callback.answer()
